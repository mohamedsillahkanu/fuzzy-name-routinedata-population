<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICF-SL Fuzzy Name Matching Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #ffffff; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; padding: 20px; }
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; }
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .logo-box { background: #ffffff; border-radius: 8px; padding: 10px; }
        .logo-box img { width: 100px; height: auto; border-radius: 6px; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; font-weight: 500; }
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; }
        .section-title { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
        
        .step-indicator { display: flex; justify-content: center; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap; }
        .step-badge { padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 13px; border: 2px solid #004080; background: #fff; color: #004080; }
        .step-badge.active { background: #004080; color: #fff; }
        .step-badge.completed { background: #28a745; color: #fff; border-color: #28a745; }
        
        .upload-section { background: #f8f9fa; padding: 2rem; border-radius: 8px; border: 2px dashed #004080; text-align: center; margin: 1rem 0; }
        .upload-section:hover { border-color: #0056b3; background: #e7f3ff; }
        .upload-section h4 { color: #004080; margin-bottom: 0.5rem; font-size: 16px; }
        .upload-section p { color: #666; font-size: 13px; }
        
        .file-input-wrapper { display: inline-block; cursor: pointer; background: #004080; color: white; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 700; text-transform: uppercase; font-family: 'Oswald', sans-serif; margin-top: 1rem; transition: all 0.2s; }
        .file-input-wrapper:hover { background: #0056b3; }
        .file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
        
        .btn { padding: 12px 24px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', sans-serif; margin: 5px; transition: all 0.2s; }
        .btn-primary { background: #004080; color: #ffffff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #ffffff; color: #004080; }
        .btn-secondary:hover { background: #004080; color: #ffffff; }
        .btn-success { background: #28a745; color: #ffffff; border-color: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-gold { background: #ffc107; color: #000; border-color: #ffc107; }
        .btn-gold:hover { background: #e0a800; }
        
        .alert { padding: 1rem; border-radius: 6px; margin: 1rem 0; font-weight: 500; }
        .alert-success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .alert-error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .alert-info { background: #e7f3ff; border: 2px solid #004080; color: #004080; }
        .alert-warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        
        .hidden { display: none !important; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #004080; }
        .form-control { width: 100%; padding: 0.75rem 1rem; border: 2px solid #004080; border-radius: 6px; font-size: 14px; background: #ffffff; color: #000; font-family: 'Oswald', sans-serif; font-weight: 500; }
        .form-control:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0,64,128,0.1); }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
        
        .config-card { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 2px solid #004080; margin: 1rem 0; }
        .config-card h4 { color: #004080; margin-bottom: 1rem; font-size: 16px; font-weight: 700; }
        
        .table-container { max-height: 400px; overflow: auto; border: 2px solid #004080; border-radius: 6px; margin: 1rem 0; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .results-table th { background: #004080; color: #ffffff; padding: 0.75rem; text-align: left; font-weight: 700; position: sticky; top: 0; }
        .results-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #ddd; }
        .results-table tr:nth-child(even) { background: #f8f9fa; }
        .results-table tr:hover { background: #e7f3ff; }
        .results-table tr.match { background: #d4edda; }
        .results-table tr.unmatch { background: #f8d7da; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin: 1rem 0; }
        .stats-card { background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #004080; }
        .stats-card h4 { color: #666; font-size: 11px; margin-bottom: 0.5rem; text-transform: uppercase; }
        .stats-card .value { font-size: 1.5rem; color: #004080; font-weight: 700; }
        .stats-card.success .value { color: #28a745; }
        .stats-card.warning .value { color: #dc3545; }
        
        .slider-container { margin: 1rem 0; }
        .slider-container label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #004080; }
        .slider { width: 100%; height: 8px; border-radius: 4px; background: #e7f3ff; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #004080; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .slider::-moz-range-thumb { width: 24px; height: 24px; border-radius: 50%; background: #004080; cursor: pointer; border: 3px solid #fff; }
        .threshold-display { text-align: center; font-size: 2rem; font-weight: 700; color: #004080; margin: 0.5rem 0; }
        
        .rename-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .rename-grid .arrow { color: #004080; font-weight: 700; }
        .rename-input { padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; font-family: 'Oswald', sans-serif; }
        .rename-input:focus { border-color: #004080; outline: none; }
        
        .file-status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-left: 10px; }
        .file-status.loaded { background: #d4edda; color: #155724; }
        .file-status.pending { background: #fff3cd; color: #856404; }
        
        .match-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .match-badge.match { background: #28a745; color: #fff; }
        .match-badge.unmatch { background: #dc3545; color: #fff; }
        
        .loading-spinner { border: 4px solid #e7f3ff; border-top: 4px solid #004080; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                </div>
            </div>
            <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
            <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
            <h1>FUZZY NAME MATCHING TOOL</h1>
            <p class="subtitle">Match Names Between Routine Data & Population Data Using Fuzzy Matching</p>
        </div>

        <div class="content-card">
            <div class="content-inner">
                <div id="alertContainer"></div>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <span class="step-badge active" id="stepBadge1">1. Upload Files</span>
                    <span class="step-badge" id="stepBadge2">2. Rename Columns</span>
                    <span class="step-badge" id="stepBadge3">3. Select & Match</span>
                    <span class="step-badge" id="stepBadge4">4. Results</span>
                </div>

                <!-- Step 1: File Upload -->
                <div id="step1">
                    <div class="section-header">
                        <span class="section-icon">1</span>
                        <span class="section-title">UPLOAD YOUR DATA FILES</span>
                    </div>

                    <div class="form-row">
                        <div class="upload-section">
                            <h4>üìä ROUTINE DATA</h4>
                            <p>Upload the file containing routine health data</p>
                            <label class="file-input-wrapper">
                                Choose File
                                <input type="file" id="routineFileInput" accept=".csv,.xlsx,.xls">
                            </label>
                            <div id="routineFileStatus"></div>
                        </div>

                        <div class="upload-section">
                            <h4>üë• POPULATION DATA</h4>
                            <p>Upload the file containing population data</p>
                            <label class="file-input-wrapper">
                                Choose File
                                <input type="file" id="populationFileInput" accept=".csv,.xlsx,.xls">
                            </label>
                            <div id="populationFileStatus"></div>
                        </div>
                    </div>

                    <div id="previewContainer" class="hidden">
                        <div class="form-row">
                            <div id="routinePreview"></div>
                            <div id="populationPreview"></div>
                        </div>
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button id="proceedToRenameBtn" class="btn btn-primary">Proceed to Column Renaming ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Column Renaming -->
                <div id="step2" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">2</span>
                        <span class="section-title">RENAME COLUMNS (OPTIONAL)</span>
                    </div>

                    <div class="alert alert-info">
                        <strong>Optional:</strong> Rename columns to standardize names across datasets. Leave as-is if no changes needed.
                    </div>

                    <div class="form-row">
                        <div class="config-card">
                            <h4>üìä Routine Data Columns</h4>
                            <div id="routineRenaming"></div>
                        </div>
                        <div class="config-card">
                            <h4>üë• Population Data Columns</h4>
                            <div id="populationRenaming"></div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button id="applyRenamingBtn" class="btn btn-primary">Apply Renaming & Continue ‚Üí</button>
                        <button id="skipRenamingBtn" class="btn btn-secondary">Skip (No Changes)</button>
                    </div>
                </div>

                <!-- Step 3: Column Selection and Matching -->
                <div id="step3" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">3</span>
                        <span class="section-title">SELECT COLUMNS & PERFORM MATCHING</span>
                    </div>

                    <div class="config-card">
                        <h4>Select Name Columns to Match</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="routineColumn">Name Column in Routine Data:</label>
                                <select id="routineColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="populationColumn">Name Column in Population Data:</label>
                                <select id="populationColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h4>Set Match Threshold</h4>
                        <p style="color: #666; font-size: 13px; margin-bottom: 1rem;">
                            Names with similarity score ‚â• threshold will be marked as "Match". Lower threshold = more matches but less accurate.
                        </p>
                        <div class="slider-container">
                            <input type="range" id="threshold" class="slider" min="0" max="100" value="70">
                            <div class="threshold-display"><span id="thresholdValue">70</span>%</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>0% (Match All)</span>
                            <span>50% (Loose)</span>
                            <span>70% (Recommended)</span>
                            <span>100% (Exact Only)</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button id="performMatchingBtn" class="btn btn-gold" style="font-size: 16px; padding: 16px 32px;">üîç PERFORM FUZZY MATCHING</button>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="step4" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">4</span>
                        <span class="section-title">MATCHING RESULTS</span>
                    </div>

                    <div class="stats-grid" id="resultsStats"></div>

                    <div id="resultsContainer"></div>

                    <div style="text-align: center; margin-top: 2rem;">
                        <button id="downloadExcelBtn" class="btn btn-success">üì• Download Results (Excel)</button>
                        <button id="downloadCSVBtn" class="btn btn-primary">üì• Download Results (CSV)</button>
                        <button id="startOverBtn" class="btn btn-secondary">Start Over</button>
                    </div>
                </div>

            </div>
        </div>

        <div class="page-footer">
            <p style="margin: 0; font-weight: 700;">National Malaria Control Programme</p>
            <p>Ministry of Health and Sanitation, Sierra Leone</p>
            <p style="font-size: 10px;">¬© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
        </div>
    </div>

    <script>
        // Global variables
        let routineData = null;
        let populationData = null;
        let matchingResults = null;
        let routineFileName = '';
        let populationFileName = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('routineFileInput').addEventListener('change', e => handleFileUpload(e, 'routine'));
            document.getElementById('populationFileInput').addEventListener('change', e => handleFileUpload(e, 'population'));
            document.getElementById('proceedToRenameBtn').addEventListener('click', () => showStep(2));
            document.getElementById('applyRenamingBtn').addEventListener('click', applyRenaming);
            document.getElementById('skipRenamingBtn').addEventListener('click', () => { setupColumnSelection(); showStep(3); });
            document.getElementById('performMatchingBtn').addEventListener('click', performMatching);
            document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);
            document.getElementById('downloadCSVBtn').addEventListener('click', downloadCSV);
            document.getElementById('startOverBtn').addEventListener('click', startOver);
            document.getElementById('threshold').addEventListener('input', updateThresholdValue);
        });

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function updateThresholdValue() {
            document.getElementById('thresholdValue').textContent = document.getElementById('threshold').value;
        }

        function showStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
                document.getElementById(`stepBadge${i}`).classList.remove('active', 'completed');
            }
            
            // Mark previous steps as completed
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById(`stepBadge${i}`).classList.add('completed');
            }
            
            // Show current step
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
            document.getElementById(`stepBadge${stepNumber}`).classList.add('active');
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name;
            const ext = fileName.split('.').pop().toLowerCase();
            const statusEl = document.getElementById(`${type}FileStatus`);
            
            statusEl.innerHTML = '<span class="file-status pending">Loading...</span>';

            if (ext === 'csv') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (type === 'routine') {
                            routineData = results.data;
                            routineFileName = fileName;
                        } else {
                            populationData = results.data;
                            populationFileName = fileName;
                        }
                        statusEl.innerHTML = `<span class="file-status loaded">‚úì ${fileName} (${results.data.length} rows)</span>`;
                        showPreview(type);
                        checkIfReadyToProceed();
                    },
                    error: function(error) {
                        showAlert('Error reading CSV: ' + error.message, 'error');
                        statusEl.innerHTML = '';
                    }
                });
            } else if (['xlsx', 'xls'].includes(ext)) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        
                        if (type === 'routine') {
                            routineData = jsonData;
                            routineFileName = fileName;
                        } else {
                            populationData = jsonData;
                            populationFileName = fileName;
                        }
                        statusEl.innerHTML = `<span class="file-status loaded">‚úì ${fileName} (${jsonData.length} rows)</span>`;
                        showPreview(type);
                        checkIfReadyToProceed();
                    } catch (error) {
                        showAlert('Error reading Excel: ' + error.message, 'error');
                        statusEl.innerHTML = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function showPreview(type) {
            const data = type === 'routine' ? routineData : populationData;
            const container = document.getElementById(`${type}Preview`);
            const title = type === 'routine' ? 'üìä Routine Data' : 'üë• Population Data';
            
            if (!data || data.length === 0) return;

            let html = `<div class="config-card"><h4>${title} Preview</h4>`;
            html += '<div class="table-container" style="max-height: 200px;"><table class="results-table">';
            html += '<thead><tr>';
            Object.keys(data[0]).forEach(col => html += `<th>${col}</th>`);
            html += '</tr></thead><tbody>';
            data.slice(0, 5).forEach(row => {
                html += '<tr>';
                Object.values(row).forEach(val => html += `<td>${val || ''}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table></div></div>';
            
            container.innerHTML = html;
        }

        function checkIfReadyToProceed() {
            if (routineData && populationData) {
                document.getElementById('previewContainer').classList.remove('hidden');
                setupRenaming();
                showAlert('Both files loaded successfully!', 'success');
            }
        }

        function setupRenaming() {
            ['routine', 'population'].forEach(type => {
                const data = type === 'routine' ? routineData : populationData;
                const container = document.getElementById(`${type}Renaming`);
                const columns = Object.keys(data[0]);
                
                let html = '';
                columns.forEach(col => {
                    html += `
                        <div class="rename-grid">
                            <span style="font-size:13px;">${col}</span>
                            <span class="arrow">‚Üí</span>
                            <input type="text" class="rename-input ${type}-rename" data-original="${col}" value="${col}">
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        function applyRenaming() {
            ['routine', 'population'].forEach(type => {
                const data = type === 'routine' ? routineData : populationData;
                const inputs = document.querySelectorAll(`.${type}-rename`);
                const columnMap = {};
                
                inputs.forEach(input => {
                    columnMap[input.dataset.original] = input.value.trim() || input.dataset.original;
                });
                
                const renamedData = data.map(row => {
                    const newRow = {};
                    Object.entries(row).forEach(([key, value]) => {
                        newRow[columnMap[key] || key] = value;
                    });
                    return newRow;
                });
                
                if (type === 'routine') routineData = renamedData;
                else populationData = renamedData;
            });
            
            setupColumnSelection();
            showStep(3);
            showAlert('Column renaming applied!', 'success');
        }

        function setupColumnSelection() {
            const routineSelect = document.getElementById('routineColumn');
            const populationSelect = document.getElementById('populationColumn');
            
            routineSelect.innerHTML = '<option value="">-- Select Column --</option>';
            populationSelect.innerHTML = '<option value="">-- Select Column --</option>';
            
            Object.keys(routineData[0]).forEach(col => {
                routineSelect.innerHTML += `<option value="${col}">${col}</option>`;
            });
            
            Object.keys(populationData[0]).forEach(col => {
                populationSelect.innerHTML += `<option value="${col}">${col}</option>`;
            });
            
            // Auto-select if column names contain common patterns
            const namePatterns = ['name', 'facility', 'hf', 'location', 'site', 'area', 'district', 'chiefdom'];
            
            [routineSelect, populationSelect].forEach(select => {
                const data = select === routineSelect ? routineData : populationData;
                const cols = Object.keys(data[0]);
                
                for (const col of cols) {
                    const colLower = col.toLowerCase();
                    if (namePatterns.some(p => colLower.includes(p))) {
                        select.value = col;
                        break;
                    }
                }
            });
        }

        function performMatching() {
            const routineCol = document.getElementById('routineColumn').value;
            const populationCol = document.getElementById('populationColumn').value;
            const threshold = parseInt(document.getElementById('threshold').value);
            
            if (!routineCol || !populationCol) {
                showAlert('Please select columns for both datasets', 'error');
                return;
            }
            
            showAlert('Performing fuzzy matching... This may take a moment.', 'info');
            
            setTimeout(() => {
                try {
                    matchingResults = calculateMatches(routineData, populationData, routineCol, populationCol, threshold);
                    displayResults(threshold);
                    showStep(4);
                    showAlert('Matching completed!', 'success');
                } catch (error) {
                    showAlert('Error during matching: ' + error.message, 'error');
                }
            }, 100);
        }

        function calculateMatches(routine, population, routineCol, populationCol, threshold) {
            const results = [];
            
            routine.forEach(routineRow => {
                const routineValue = String(routineRow[routineCol] || '').trim();
                const routineLower = routineValue.toLowerCase();
                
                let bestMatch = null;
                let bestScore = 0;
                
                population.forEach(popRow => {
                    const popValue = String(popRow[populationCol] || '').trim();
                    const popLower = popValue.toLowerCase();
                    
                    const score = jaroWinkler(routineLower, popLower) * 100;
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = popRow;
                    }
                });
                
                const isMatch = bestScore >= threshold;
                
                const resultRow = {
                    'Name_in_Routine': routineValue,
                    'Best_Match_in_Population': bestMatch ? bestMatch[populationCol] : '',
                    'Match_Score': Math.round(bestScore),
                    'Match_Status': isMatch ? 'MATCH' : 'UNMATCH',
                    'Suggested_Name': isMatch && bestMatch ? bestMatch[populationCol] : routineValue
                };
                
                // Add other routine columns
                Object.entries(routineRow).forEach(([key, value]) => {
                    if (key !== routineCol) {
                        resultRow[`${key}_Routine`] = value;
                    }
                });
                
                // Add matched population columns
                if (bestMatch) {
                    Object.entries(bestMatch).forEach(([key, value]) => {
                        if (key !== populationCol) {
                            resultRow[`${key}_Population`] = value;
                        }
                    });
                }
                
                results.push(resultRow);
            });
            
            // Sort by match score descending
            results.sort((a, b) => b.Match_Score - a.Match_Score);
            
            return results;
        }

        /**
         * Jaro-Winkler Similarity Algorithm
         */
        function jaroWinkler(s1, s2) {
            if (s1 === s2) return 1;
            if (!s1 || !s2) return 0;
            
            const len1 = s1.length;
            const len2 = s2.length;
            
            const matchWindow = Math.floor(Math.max(len1, len2) / 2) - 1;
            const s1Matches = new Array(len1).fill(false);
            const s2Matches = new Array(len2).fill(false);
            
            let matches = 0;
            let transpositions = 0;
            
            // Find matches
            for (let i = 0; i < len1; i++) {
                const start = Math.max(0, i - matchWindow);
                const end = Math.min(i + matchWindow + 1, len2);
                
                for (let j = start; j < end; j++) {
                    if (s2Matches[j] || s1[i] !== s2[j]) continue;
                    s1Matches[i] = true;
                    s2Matches[j] = true;
                    matches++;
                    break;
                }
            }
            
            if (matches === 0) return 0;
            
            // Count transpositions
            let k = 0;
            for (let i = 0; i < len1; i++) {
                if (!s1Matches[i]) continue;
                while (!s2Matches[k]) k++;
                if (s1[i] !== s2[k]) transpositions++;
                k++;
            }
            
            const jaro = (matches / len1 + matches / len2 + (matches - transpositions / 2) / matches) / 3;
            
            // Winkler prefix bonus
            let prefix = 0;
            for (let i = 0; i < Math.min(len1, len2, 4); i++) {
                if (s1[i] === s2[i]) prefix++;
                else break;
            }
            
            return jaro + 0.1 * prefix * (1 - jaro);
        }

        function displayResults(threshold) {
            const totalRecords = matchingResults.length;
            const matches = matchingResults.filter(r => r.Match_Status === 'MATCH').length;
            const unmatches = totalRecords - matches;
            const avgScore = Math.round(matchingResults.reduce((sum, r) => sum + r.Match_Score, 0) / totalRecords);
            
            // Stats
            document.getElementById('resultsStats').innerHTML = `
                <div class="stats-card"><h4>Total Records</h4><div class="value">${totalRecords}</div></div>
                <div class="stats-card success"><h4>Matches (‚â•${threshold}%)</h4><div class="value">${matches}</div></div>
                <div class="stats-card warning"><h4>Unmatched</h4><div class="value">${unmatches}</div></div>
                <div class="stats-card"><h4>Match Rate</h4><div class="value">${Math.round(matches/totalRecords*100)}%</div></div>
                <div class="stats-card"><h4>Avg Score</h4><div class="value">${avgScore}%</div></div>
            `;
            
            // Table
            let html = '<div class="table-container"><table class="results-table">';
            html += '<thead><tr>';
            ['Name_in_Routine', 'Best_Match_in_Population', 'Match_Score', 'Match_Status', 'Suggested_Name'].forEach(col => {
                html += `<th>${col.replace(/_/g, ' ')}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            matchingResults.slice(0, 100).forEach(row => {
                const rowClass = row.Match_Status === 'MATCH' ? 'match' : 'unmatch';
                html += `<tr class="${rowClass}">`;
                html += `<td>${row.Name_in_Routine}</td>`;
                html += `<td>${row.Best_Match_in_Population}</td>`;
                html += `<td><strong>${row.Match_Score}%</strong></td>`;
                html += `<td><span class="match-badge ${row.Match_Status.toLowerCase()}">${row.Match_Status}</span></td>`;
                html += `<td>${row.Suggested_Name}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            if (matchingResults.length > 100) {
                html += `<p style="color:#666; margin-top:1rem; text-align:center;">Showing first 100 of ${matchingResults.length} results. Download to see all.</p>`;
            }
            
            document.getElementById('resultsContainer').innerHTML = html;
        }

        function downloadExcel() {
            if (!matchingResults) {
                showAlert('No results to download', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(matchingResults);
            XLSX.utils.book_append_sheet(wb, ws, 'Matching Results');
            
            XLSX.writeFile(wb, 'fuzzy_matching_results.xlsx');
            showAlert('Excel file downloaded!', 'success');
        }

        function downloadCSV() {
            if (!matchingResults) {
                showAlert('No results to download', 'error');
                return;
            }
            
            const csv = Papa.unparse(matchingResults);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'fuzzy_matching_results.csv';
            a.click();
            showAlert('CSV file downloaded!', 'success');
        }

        function startOver() {
            routineData = null;
            populationData = null;
            matchingResults = null;
            
            document.getElementById('routineFileInput').value = '';
            document.getElementById('populationFileInput').value = '';
            document.getElementById('routineFileStatus').innerHTML = '';
            document.getElementById('populationFileStatus').innerHTML = '';
            document.getElementById('routinePreview').innerHTML = '';
            document.getElementById('populationPreview').innerHTML = '';
            document.getElementById('previewContainer').classList.add('hidden');
            
            showStep(1);
            showAlert('Reset complete. Upload new files to start.', 'info');
        }
    </script>
</body>
</html>
