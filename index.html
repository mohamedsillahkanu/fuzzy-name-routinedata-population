<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICF-SL Fuzzy Name Matching Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #ffffff; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; padding: 20px; }
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; }
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .logo-box { background: #ffffff; border-radius: 8px; padding: 10px; }
        .logo-box img { width: 100px; height: auto; border-radius: 6px; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; font-weight: 500; }
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; }
        .section-title { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
        
        .step-indicator { display: flex; justify-content: center; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap; }
        .step-badge { padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 13px; border: 2px solid #004080; background: #fff; color: #004080; }
        .step-badge.active { background: #004080; color: #fff; }
        .step-badge.completed { background: #28a745; color: #fff; border-color: #28a745; }
        
        .upload-section { background: #f8f9fa; padding: 2rem; border-radius: 8px; border: 2px dashed #004080; text-align: center; margin: 1rem 0; }
        .upload-section:hover { border-color: #0056b3; background: #e7f3ff; }
        .upload-section h4 { color: #004080; margin-bottom: 0.5rem; font-size: 16px; }
        .upload-section p { color: #666; font-size: 13px; }
        
        .file-input-wrapper { display: inline-block; cursor: pointer; background: #004080; color: white; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 700; text-transform: uppercase; font-family: 'Oswald', sans-serif; margin-top: 1rem; transition: all 0.2s; }
        .file-input-wrapper:hover { background: #0056b3; }
        .file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
        
        .btn { padding: 12px 24px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', sans-serif; margin: 5px; transition: all 0.2s; }
        .btn-primary { background: #004080; color: #ffffff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #ffffff; color: #004080; }
        .btn-secondary:hover { background: #004080; color: #ffffff; }
        .btn-success { background: #28a745; color: #ffffff; border-color: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-gold { background: #ffc107; color: #000; border-color: #ffc107; }
        .btn-gold:hover { background: #e0a800; }
        .btn-orange { background: #fd7e14; color: #fff; border-color: #fd7e14; }
        .btn-orange:hover { background: #e96b02; }
        
        .alert { padding: 1rem; border-radius: 6px; margin: 1rem 0; font-weight: 500; }
        .alert-success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .alert-error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .alert-info { background: #e7f3ff; border: 2px solid #004080; color: #004080; }
        .alert-warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        
        .hidden { display: none !important; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #004080; }
        .form-control { width: 100%; padding: 0.75rem 1rem; border: 2px solid #004080; border-radius: 6px; font-size: 14px; background: #ffffff; color: #000; font-family: 'Oswald', sans-serif; font-weight: 500; }
        .form-control:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0,64,128,0.1); }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
        
        .config-card { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 2px solid #004080; margin: 1rem 0; }
        .config-card h4 { color: #004080; margin-bottom: 1rem; font-size: 16px; font-weight: 700; }
        
        .table-container { max-height: 500px; overflow: auto; border: 2px solid #004080; border-radius: 6px; margin: 1rem 0; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .results-table th { background: #004080; color: #ffffff; padding: 0.75rem; text-align: left; font-weight: 700; position: sticky; top: 0; }
        .results-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #ddd; }
        .results-table tr:nth-child(even) { background: #f8f9fa; }
        .results-table tr:hover { background: #e7f3ff; }
        .results-table tr.match { background: #d4edda; }
        .results-table tr.unmatch { background: #f8d7da; }
        .results-table tr.applied { background: #cce5ff; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin: 1rem 0; }
        .stats-card { background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #004080; }
        .stats-card h4 { color: #666; font-size: 11px; margin-bottom: 0.5rem; text-transform: uppercase; }
        .stats-card .value { font-size: 1.5rem; color: #004080; font-weight: 700; }
        .stats-card.success .value { color: #28a745; }
        .stats-card.warning .value { color: #dc3545; }
        .stats-card.routine { border-color: #17a2b8; }
        .stats-card.routine .value { color: #17a2b8; }
        .stats-card.population { border-color: #6c757d; }
        .stats-card.population .value { color: #6c757d; }
        
        .slider-container { margin: 1rem 0; }
        .slider-container label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: #004080; }
        .slider { width: 100%; height: 8px; border-radius: 4px; background: #e7f3ff; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #004080; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .slider::-moz-range-thumb { width: 24px; height: 24px; border-radius: 50%; background: #004080; cursor: pointer; border: 3px solid #fff; }
        .threshold-display { text-align: center; font-size: 2rem; font-weight: 700; color: #004080; margin: 0.5rem 0; }
        
        .rename-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .rename-grid .arrow { color: #004080; font-weight: 700; }
        .rename-input { padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; font-family: 'Oswald', sans-serif; }
        .rename-input:focus { border-color: #004080; outline: none; }
        
        .file-status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-left: 10px; }
        .file-status.loaded { background: #d4edda; color: #155724; }
        .file-status.pending { background: #fff3cd; color: #856404; }
        
        .match-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .match-badge.match { background: #28a745; color: #fff; }
        .match-badge.unmatch { background: #dc3545; color: #fff; }
        .match-badge.applied { background: #007bff; color: #fff; }
        
        .loading-spinner { border: 4px solid #e7f3ff; border-top: 4px solid #004080; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .value-cell { font-weight: 600; }
        .value-cell.routine { color: #004080; }
        .value-cell.population { color: #6c757d; }
        
        .button-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 2rem; }
        
        .routine-values-box { background: #e7f3ff; border: 2px solid #17a2b8; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .routine-values-box h5 { color: #17a2b8; font-size: 14px; margin-bottom: 0.5rem; }
        .routine-values-list { max-height: 150px; overflow-y: auto; font-size: 12px; color: #333; }
        .routine-values-list span { display: inline-block; background: #fff; border: 1px solid #17a2b8; padding: 2px 8px; margin: 2px; border-radius: 4px; }
        
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                </div>
            </div>
            <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
            <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
            <h1>FUZZY NAME MATCHING TOOL</h1>
            <p class="subtitle">Standardize Population Data Names to Match Routine Data Categories</p>
        </div>

        <div class="content-card">
            <div class="content-inner">
                <div id="alertContainer"></div>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <span class="step-badge active" id="stepBadge1">1. Upload Files</span>
                    <span class="step-badge" id="stepBadge2">2. Rename Columns</span>
                    <span class="step-badge" id="stepBadge3">3. Select & Match</span>
                    <span class="step-badge" id="stepBadge4">4. Results</span>
                </div>

                <!-- Step 1: File Upload -->
                <div id="step1">
                    <div class="section-header">
                        <span class="section-icon">1</span>
                        <span class="section-title">UPLOAD YOUR DATA FILES</span>
                    </div>

                    <div class="form-row">
                        <div class="upload-section">
                            <h4>üìä ROUTINE DATA</h4>
                            <p>Upload the file containing routine health data (reference values)</p>
                            <label class="file-input-wrapper">
                                Choose File
                                <input type="file" id="routineFileInput" accept=".csv,.xlsx,.xls">
                            </label>
                            <div id="routineFileStatus"></div>
                        </div>

                        <div class="upload-section">
                            <h4>üë• POPULATION DATA</h4>
                            <p>Upload the file containing population data (to be standardized)</p>
                            <label class="file-input-wrapper">
                                Choose File
                                <input type="file" id="populationFileInput" accept=".csv,.xlsx,.xls">
                            </label>
                            <div id="populationFileStatus"></div>
                        </div>
                    </div>

                    <div id="proceedContainer" class="hidden" style="text-align: center; margin-top: 1.5rem;">
                        <button id="proceedToRenameBtn" class="btn btn-primary">Proceed to Column Renaming ‚Üí</button>
                    </div>
                </div>

                <!-- Step 2: Column Renaming -->
                <div id="step2" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">2</span>
                        <span class="section-title">RENAME COLUMNS (OPTIONAL)</span>
                    </div>

                    <div class="alert alert-info">
                        <strong>Optional:</strong> Rename columns to standardize names across datasets. Leave as-is if no changes needed.
                    </div>

                    <div class="form-row">
                        <div class="config-card">
                            <h4>üìä Routine Data Columns</h4>
                            <div id="routineRenaming"></div>
                        </div>
                        <div class="config-card">
                            <h4>üë• Population Data Columns</h4>
                            <div id="populationRenaming"></div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button id="applyRenamingBtn" class="btn btn-primary">Apply Renaming & Continue ‚Üí</button>
                        <button id="skipRenamingBtn" class="btn btn-secondary">Skip (No Changes)</button>
                    </div>
                </div>

                <!-- Step 3: Column Selection and Matching -->
                <div id="step3" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">3</span>
                        <span class="section-title">SELECT COLUMNS & PERFORM MATCHING</span>
                    </div>

                    <div class="config-card">
                        <h4>Select Name Columns to Match</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="routineColumn">Name Column in Routine Data (Reference):</label>
                                <select id="routineColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="populationColumn">Name Column in Population Data (To Standardize):</label>
                                <select id="populationColumn" class="form-control">
                                    <option value="">-- Select Column --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h4>Set Match Threshold</h4>
                        <p style="color: #666; font-size: 13px; margin-bottom: 1rem;">
                            Population values with similarity score ‚â• threshold will be marked as MATCH and replaced with the routine value.
                        </p>
                        <div class="slider-container">
                            <input type="range" id="threshold" class="slider" min="0" max="100" value="70">
                            <div class="threshold-display"><span id="thresholdValue">70</span>%</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>0% (Match All)</span>
                            <span>50% (Loose)</span>
                            <span>70% (Recommended)</span>
                            <span>100% (Exact Only)</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button id="performMatchingBtn" class="btn btn-gold" style="font-size: 16px; padding: 16px 32px;">üîç PERFORM FUZZY MATCHING</button>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="step4" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">4</span>
                        <span class="section-title">MATCHING RESULTS</span>
                    </div>

                    <div class="stats-grid" id="resultsStats"></div>
                    
                    <div id="routineValuesContainer"></div>

                    <div id="resultsContainer"></div>

                    <div class="button-group">
                        <button id="modifyThresholdBtn" class="btn btn-secondary">‚Üê Modify Threshold</button>
                        <button id="applyChangesBtn" class="btn btn-orange" style="font-size:16px; padding:14px 28px;">‚úì APPLY CHANGES</button>
                        <button id="downloadExcelBtn" class="btn btn-gold hidden">üì• Download Excel</button>
                        <button id="downloadCSVBtn" class="btn btn-success hidden">üì• Download CSV</button>
                        <button id="startOverBtn" class="btn btn-secondary">Start Over</button>
                    </div>
                </div>

            </div>
        </div>

        <div class="page-footer">
            <p style="margin: 0; font-weight: 700;">National Malaria Control Programme</p>
            <p>Ministry of Health and Sanitation, Sierra Leone</p>
            <p style="font-size: 10px;">¬© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
        </div>
    </div>

    <script>
        // Global variables
        let routineData = null;
        let populationData = null;
        let originalPopulationData = null;
        let matchingResults = null;
        let routineFileName = '';
        let populationFileName = '';
        let changesApplied = false;
        let routineUniqueValues = [];
        let populationUniqueValues = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('routineFileInput').addEventListener('change', e => handleFileUpload(e, 'routine'));
            document.getElementById('populationFileInput').addEventListener('change', e => handleFileUpload(e, 'population'));
            document.getElementById('proceedToRenameBtn').addEventListener('click', () => showStep(2));
            document.getElementById('applyRenamingBtn').addEventListener('click', applyRenaming);
            document.getElementById('skipRenamingBtn').addEventListener('click', () => { setupColumnSelection(); showStep(3); });
            document.getElementById('performMatchingBtn').addEventListener('click', performMatching);
            document.getElementById('modifyThresholdBtn').addEventListener('click', () => { changesApplied = false; showStep(3); });
            document.getElementById('applyChangesBtn').addEventListener('click', applyChanges);
            document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);
            document.getElementById('downloadCSVBtn').addEventListener('click', downloadCSV);
            document.getElementById('startOverBtn').addEventListener('click', startOver);
            document.getElementById('threshold').addEventListener('input', updateThresholdValue);
        });

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function updateThresholdValue() {
            document.getElementById('thresholdValue').textContent = document.getElementById('threshold').value;
        }

        function showStep(stepNumber) {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
                document.getElementById(`stepBadge${i}`).classList.remove('active', 'completed');
            }
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById(`stepBadge${i}`).classList.add('completed');
            }
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
            document.getElementById(`stepBadge${stepNumber}`).classList.add('active');
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name;
            const ext = fileName.split('.').pop().toLowerCase();
            const statusEl = document.getElementById(`${type}FileStatus`);
            
            statusEl.innerHTML = '<span class="file-status pending">Loading...</span>';

            if (ext === 'csv') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (type === 'routine') {
                            routineData = results.data;
                            routineFileName = fileName;
                        } else {
                            populationData = results.data;
                            originalPopulationData = JSON.parse(JSON.stringify(results.data));
                            populationFileName = fileName;
                        }
                        statusEl.innerHTML = `<span class="file-status loaded">‚úì ${fileName} (${results.data.length} rows)</span>`;
                        checkIfReadyToProceed();
                    },
                    error: function(error) {
                        showAlert('Error reading CSV: ' + error.message, 'error');
                        statusEl.innerHTML = '';
                    }
                });
            } else if (['xlsx', 'xls'].includes(ext)) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        
                        if (type === 'routine') {
                            routineData = jsonData;
                            routineFileName = fileName;
                        } else {
                            populationData = jsonData;
                            originalPopulationData = JSON.parse(JSON.stringify(jsonData));
                            populationFileName = fileName;
                        }
                        statusEl.innerHTML = `<span class="file-status loaded">‚úì ${fileName} (${jsonData.length} rows)</span>`;
                        checkIfReadyToProceed();
                    } catch (error) {
                        showAlert('Error reading Excel: ' + error.message, 'error');
                        statusEl.innerHTML = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function checkIfReadyToProceed() {
            if (routineData && populationData) {
                document.getElementById('proceedContainer').classList.remove('hidden');
                setupRenaming();
                showAlert('Both files loaded successfully! Click "Proceed" to continue.', 'success');
            }
        }

        function setupRenaming() {
            ['routine', 'population'].forEach(type => {
                const data = type === 'routine' ? routineData : populationData;
                const container = document.getElementById(`${type}Renaming`);
                const columns = Object.keys(data[0]);
                
                let html = '';
                columns.forEach(col => {
                    html += `
                        <div class="rename-grid">
                            <span style="font-size:13px;">${col}</span>
                            <span class="arrow">‚Üí</span>
                            <input type="text" class="rename-input ${type}-rename" data-original="${col}" value="${col}">
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        function applyRenaming() {
            ['routine', 'population'].forEach(type => {
                const data = type === 'routine' ? routineData : populationData;
                const inputs = document.querySelectorAll(`.${type}-rename`);
                const columnMap = {};
                
                inputs.forEach(input => {
                    columnMap[input.dataset.original] = input.value.trim() || input.dataset.original;
                });
                
                const renamedData = data.map(row => {
                    const newRow = {};
                    Object.entries(row).forEach(([key, value]) => {
                        newRow[columnMap[key] || key] = value;
                    });
                    return newRow;
                });
                
                if (type === 'routine') {
                    routineData = renamedData;
                } else {
                    populationData = renamedData;
                    originalPopulationData = JSON.parse(JSON.stringify(renamedData));
                }
            });
            
            setupColumnSelection();
            showStep(3);
            showAlert('Column renaming applied!', 'success');
        }

        function setupColumnSelection() {
            const routineSelect = document.getElementById('routineColumn');
            const populationSelect = document.getElementById('populationColumn');
            
            routineSelect.innerHTML = '<option value="">-- Select Column --</option>';
            populationSelect.innerHTML = '<option value="">-- Select Column --</option>';
            
            Object.keys(routineData[0]).forEach(col => {
                routineSelect.innerHTML += `<option value="${col}">${col}</option>`;
            });
            
            Object.keys(populationData[0]).forEach(col => {
                populationSelect.innerHTML += `<option value="${col}">${col}</option>`;
            });
            
            const namePatterns = ['name', 'facility', 'hf', 'location', 'site', 'area', 'district', 'chiefdom'];
            
            [routineSelect, populationSelect].forEach(select => {
                const data = select === routineSelect ? routineData : populationData;
                const cols = Object.keys(data[0]);
                
                for (const col of cols) {
                    const colLower = col.toLowerCase();
                    if (namePatterns.some(p => colLower.includes(p))) {
                        select.value = col;
                        break;
                    }
                }
            });
        }

        let matchColRoutine = '';
        let matchColPopulation = '';

        function performMatching() {
            const routineCol = document.getElementById('routineColumn').value;
            const populationCol = document.getElementById('populationColumn').value;
            const threshold = parseInt(document.getElementById('threshold').value);
            
            if (!routineCol || !populationCol) {
                showAlert('Please select columns for both datasets', 'error');
                return;
            }
            
            matchColRoutine = routineCol;
            matchColPopulation = populationCol;
            changesApplied = false;
            
            // Reset population data to original
            populationData = JSON.parse(JSON.stringify(originalPopulationData));
            
            // Reset button visibility
            document.getElementById('applyChangesBtn').classList.remove('hidden');
            document.getElementById('downloadExcelBtn').classList.add('hidden');
            document.getElementById('downloadCSVBtn').classList.add('hidden');
            
            showStep(4);
            document.getElementById('resultsStats').innerHTML = '';
            document.getElementById('routineValuesContainer').innerHTML = '';
            document.getElementById('resultsContainer').innerHTML = `
                <div style="text-align:center; padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p id="matchProgress" style="margin-top:1rem; color:#004080; font-weight:700;">Extracting unique values...</p>
                </div>
            `;
            
            setTimeout(() => {
                try {
                    // Extract unique values
                    routineUniqueValues = [...new Set(
                        routineData.map(r => String(r[routineCol] || '').trim()).filter(v => v)
                    )].sort();
                    
                    populationUniqueValues = [...new Set(
                        populationData.map(r => String(r[populationCol] || '').trim()).filter(v => v)
                    )].sort();
                    
                    document.getElementById('matchProgress').textContent = 
                        `Found ${routineUniqueValues.length} unique routine values, ${populationUniqueValues.length} unique population values. Matching...`;
                    
                    setTimeout(() => {
                        matchingResults = matchUniqueValues(populationUniqueValues, routineUniqueValues, threshold, populationCol);
                        displayResults(threshold);
                        showAlert(`Matching complete! Threshold: ${threshold}%`, 'success');
                    }, 50);
                    
                } catch (error) {
                    showAlert('Error during matching: ' + error.message, 'error');
                }
            }, 50);
        }

        /**
         * Match unique population values to routine values
         */
        function matchUniqueValues(populationUnique, routineUnique, threshold, populationCol) {
            const routineLowerMap = routineUnique.map(v => ({ original: v, lower: v.toLowerCase() }));
            
            const results = [];
            
            populationUnique.forEach(popValue => {
                const popLower = popValue.toLowerCase();
                
                let bestMatch = null;
                let bestScore = 0;
                
                for (const routine of routineLowerMap) {
                    if (popLower === routine.lower) {
                        bestMatch = routine.original;
                        bestScore = 100;
                        break;
                    }
                    
                    const score = jaroWinkler(popLower, routine.lower) * 100;
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = routine.original;
                    }
                }
                
                const roundedScore = Math.round(bestScore);
                const isMatch = roundedScore >= threshold;
                
                results.push({
                    Name_in_Population: popValue,
                    Name_in_Routine: bestMatch || '',
                    Match_Score: roundedScore,
                    Match_Status: isMatch ? 'MATCH' : 'UNMATCH',
                    Final_Value: isMatch ? bestMatch : popValue
                });
            });
            
            // Sort: Matches first by score desc, then unmatches by score desc
            results.sort((a, b) => {
                if (a.Match_Status !== b.Match_Status) {
                    return a.Match_Status === 'MATCH' ? -1 : 1;
                }
                return b.Match_Score - a.Match_Score;
            });
            
            return results;
        }

        /**
         * Jaro-Winkler Similarity Algorithm
         */
        function jaroWinkler(s1, s2) {
            if (s1 === s2) return 1;
            if (!s1 || !s2) return 0;
            
            const len1 = s1.length;
            const len2 = s2.length;
            
            const matchWindow = Math.floor(Math.max(len1, len2) / 2) - 1;
            const s1Matches = new Array(len1).fill(false);
            const s2Matches = new Array(len2).fill(false);
            
            let matches = 0;
            let transpositions = 0;
            
            for (let i = 0; i < len1; i++) {
                const start = Math.max(0, i - matchWindow);
                const end = Math.min(i + matchWindow + 1, len2);
                
                for (let j = start; j < end; j++) {
                    if (s2Matches[j] || s1[i] !== s2[j]) continue;
                    s1Matches[i] = true;
                    s2Matches[j] = true;
                    matches++;
                    break;
                }
            }
            
            if (matches === 0) return 0;
            
            let k = 0;
            for (let i = 0; i < len1; i++) {
                if (!s1Matches[i]) continue;
                while (!s2Matches[k]) k++;
                if (s1[i] !== s2[k]) transpositions++;
                k++;
            }
            
            const jaro = (matches / len1 + matches / len2 + (matches - transpositions / 2) / matches) / 3;
            
            let prefix = 0;
            for (let i = 0; i < Math.min(len1, len2, 4); i++) {
                if (s1[i] === s2[i]) prefix++;
                else break;
            }
            
            return jaro + 0.1 * prefix * (1 - jaro);
        }

        function displayResults(threshold) {
            const uniqueRoutineCount = routineUniqueValues.length;
            const uniquePopCount = populationUniqueValues.length;
            const matches = matchingResults.filter(r => r.Match_Status === 'MATCH').length;
            const unmatches = uniquePopCount - matches;
            
            // Stats - showing unique counts for both
            document.getElementById('resultsStats').innerHTML = `
                <div class="stats-card"><h4>Threshold</h4><div class="value">${threshold}%</div></div>
                <div class="stats-card routine"><h4>Unique Routine Values</h4><div class="value">${uniqueRoutineCount}</div></div>
                <div class="stats-card population"><h4>Unique Population Values</h4><div class="value">${uniquePopCount}</div></div>
                <div class="stats-card success"><h4>Matched (‚â•${threshold}%)</h4><div class="value">${matches}</div></div>
                <div class="stats-card warning"><h4>Unmatched (<${threshold}%)</h4><div class="value">${unmatches}</div></div>
            `;
            
            // Show routine values for reference
            document.getElementById('routineValuesContainer').innerHTML = `
                <div class="routine-values-box">
                    <h5>üìä Reference: All Unique Routine Values (${uniqueRoutineCount} values)</h5>
                    <div class="routine-values-list">
                        ${routineUniqueValues.map(v => `<span>${escapeHtml(v)}</span>`).join('')}
                    </div>
                </div>
            `;
            
            let html = `
                <div class="alert alert-info">
                    <strong>Logic:</strong> If Score ‚â• ${threshold}% ‚Üí MATCH (use Routine value). If Score < ${threshold}% ‚Üí UNMATCH (keep Population value).<br>
                    <strong>Edit:</strong> You can manually edit the "Final Value" column before applying.
                </div>
            `;
            
            html += '<div class="table-container"><table class="results-table">';
            html += `<thead><tr>
                <th>Name in Population</th>
                <th>Name in Routine (Best Match)</th>
                <th>Score</th>
                <th>Status</th>
                <th>Final Value (Editable)</th>
            </tr></thead><tbody>`;
            
            matchingResults.forEach((row, idx) => {
                const rowClass = row.Match_Status === 'MATCH' ? 'match' : 'unmatch';
                
                html += `<tr class="${rowClass}" id="row-${idx}">`;
                html += `<td class="value-cell population">${escapeHtml(row.Name_in_Population)}</td>`;
                html += `<td class="value-cell routine">${escapeHtml(row.Name_in_Routine)}</td>`;
                html += `<td><strong>${row.Match_Score}%</strong></td>`;
                html += `<td><span class="match-badge ${row.Match_Status.toLowerCase()}">${row.Match_Status}</span></td>`;
                html += `<td><input type="text" class="rename-input final-value-input" data-idx="${idx}" value="${escapeHtml(row.Final_Value)}" style="width:100%;"></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('resultsContainer').innerHTML = html;
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function applyChanges() {
            if (!matchingResults) {
                showAlert('No results to apply', 'error');
                return;
            }
            
            // Get user-edited final values
            const inputs = document.querySelectorAll('.final-value-input');
            inputs.forEach(input => {
                const idx = parseInt(input.dataset.idx);
                matchingResults[idx].Final_Value = input.value.trim();
            });
            
            // Create mapping: population value ‚Üí final value
            const mapping = {};
            matchingResults.forEach(r => {
                mapping[r.Name_in_Population] = r.Final_Value;
            });
            
            // Apply mapping to population data
            populationData = originalPopulationData.map(row => {
                const newRow = { ...row };
                const originalValue = String(row[matchColPopulation] || '').trim();
                // Store original if not already stored
                if (!newRow[matchColPopulation + '_Original']) {
                    newRow[matchColPopulation + '_Original'] = originalValue;
                }
                // Replace with final value
                newRow[matchColPopulation] = mapping[originalValue] || originalValue;
                return newRow;
            });
            
            changesApplied = true;
            
            // Update all rows to show applied status
            matchingResults.forEach((row, idx) => {
                const tableRow = document.getElementById(`row-${idx}`);
                if (tableRow) {
                    tableRow.classList.remove('match', 'unmatch');
                    tableRow.classList.add('applied');
                    const badge = tableRow.querySelector('.match-badge');
                    if (badge) {
                        badge.classList.remove('match', 'unmatch');
                        badge.classList.add('applied');
                        badge.textContent = 'APPLIED';
                    }
                }
            });
            
            // Update stats
            const statsContainer = document.getElementById('resultsStats');
            statsContainer.innerHTML += `
                <div class="stats-card" style="background:#cce5ff; border-color:#007bff;">
                    <h4>Status</h4>
                    <div class="value" style="color:#007bff; font-size:1rem;">‚úì APPLIED</div>
                </div>
            `;
            
            // Show download buttons, hide apply button
            document.getElementById('applyChangesBtn').classList.add('hidden');
            document.getElementById('downloadExcelBtn').classList.remove('hidden');
            document.getElementById('downloadCSVBtn').classList.remove('hidden');
            
            showAlert('Changes applied successfully! You can now download the standardized data.', 'success');
        }

        function downloadExcel() {
            if (!changesApplied) {
                showAlert('Please apply changes first before downloading', 'warning');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Standardized Population Data
            const ws1 = XLSX.utils.json_to_sheet(populationData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Standardized Population Data');
            
            // Sheet 2: Mapping Reference
            const mappingData = matchingResults.map(r => ({
                'Name in Population': r.Name_in_Population,
                'Name in Routine': r.Name_in_Routine,
                'Match Score': r.Match_Score + '%',
                'Match Status': r.Match_Status,
                'Final Value Applied': r.Final_Value
            }));
            const ws2 = XLSX.utils.json_to_sheet(mappingData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Value Mapping Reference');
            
            // Sheet 3: Routine Values Reference
            const routineRefData = routineUniqueValues.map(v => ({ 'Routine Value': v }));
            const ws3 = XLSX.utils.json_to_sheet(routineRefData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Routine Values Reference');
            
            XLSX.writeFile(wb, 'standardized_population_data.xlsx');
            showAlert('Excel file downloaded successfully!', 'success');
        }

        function downloadCSV() {
            if (!changesApplied) {
                showAlert('Please apply changes first before downloading', 'warning');
                return;
            }
            
            const csv = Papa.unparse(populationData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'standardized_population_data.csv';
            a.click();
            showAlert('CSV file downloaded successfully!', 'success');
        }

        function startOver() {
            routineData = null;
            populationData = null;
            originalPopulationData = null;
            matchingResults = null;
            changesApplied = false;
            routineUniqueValues = [];
            populationUniqueValues = [];
            
            document.getElementById('routineFileInput').value = '';
            document.getElementById('populationFileInput').value = '';
            document.getElementById('routineFileStatus').innerHTML = '';
            document.getElementById('populationFileStatus').innerHTML = '';
            document.getElementById('proceedContainer').classList.add('hidden');
            
            showStep(1);
            showAlert('Reset complete. Upload new files to start.', 'info');
        }
    </script>
</body>
</html>
